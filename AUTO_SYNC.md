# 🔄 Автоматическая синхронизация бота с админ-панелью

## Обзор системы

Система автоматической синхронизации позволяет изменять конфигурацию стендов и вопросов через веб-админ панель **без перезапуска бота**. Все изменения применяются мгновенно!

## Компоненты системы

### 1. ConfigManager (`config_manager.py`)
**Горячая перезагрузка конфигурации**
- Мониторинг изменений в `config.py`
- Автоматическая перезагрузка модуля
- Thread-safe доступ к конфигурации
- Callbacks для уведомления об изменениях

### 2. SyncServer (`sync_server.py`)
**HTTP сервер для синхронизации**
- Порт: `8765` (по умолчанию)
- API endpoints для уведомлений
- Обработка запросов от админ-панели

### 3. Интеграция в боте
**Обновленные модули:**
- `bot.py` - запуск sync сервера
- `handlers.py` - использование config_manager
- `menu.py` - динамическая загрузка стендов

## API Endpoints

### GET /health
Проверка состояния сервера синхронизации
```bash
curl http://localhost:8765/health
```

### POST /reload-config
Принудительная перезагрузка конфигурации
```bash
curl -X POST http://localhost:8765/reload-config
```

### POST /webhook
Универсальный webhook для уведомлений
```bash
curl -X POST http://localhost:8765/webhook \
  -H "Content-Type: application/json" \
  -d '{"type": "config_changed"}'
```

## Как это работает

### 1. Редактирование в админ-панели
1. Пользователь изменяет стенды/вопросы в веб-интерфейсе
2. Нажимает "Сохранить изменения"
3. Админ-панель обновляет `config.py`

### 2. Автоматическое уведомление
1. Админ-панель отправляет HTTP запрос боту (`POST /reload-config`)
2. SyncServer получает уведомление
3. ConfigManager перезагружает конфигурацию

### 3. Применение изменений
1. Все модули бота получают новую конфигурацию
2. Меню и стенды обновляются автоматически
3. Пользователи видят изменения мгновенно

## Схема работы

```
┌─────────────────┐    HTTP POST     ┌──────────────────┐
│  Админ-панель   │─────────────────▶│   SyncServer     │
│  (port 5001)    │  /reload-config  │   (port 8765)    │
└─────────────────┘                  └──────────────────┘
         │                                       │
         ▼                                       ▼
┌─────────────────┐                  ┌──────────────────┐
│   config.py     │◀─────────────────│ ConfigManager    │
│   (изменения)   │   file monitor   │ (hot reload)     │
└─────────────────┘                  └──────────────────┘
                                              │
                                              ▼
                                   ┌──────────────────┐
                                   │  Bot Handlers    │
                                   │  (новые стенды)  │
                                   └──────────────────┘
```

## Мониторинг синхронизации

### Логи бота
```
[INFO] Configuration reloaded successfully
[INFO] Sync server started on localhost:8765
[INFO] Configuration reload triggered via API
```

### Статус в админ-панели
- ✅ **Бот уведомлен** - синхронизация успешна
- ❌ **Бот не отвечает** - требуется ручной перезапуск

## Устранение неполадок

### Бот не получает уведомления
1. Проверьте, запущен ли бот с новым кодом
2. Убедитесь, что порт 8765 свободен
3. Проверьте логи на ошибки

### Конфигурация не обновляется
1. Проверьте синтаксис в `config.py`
2. Убедитесь в правах на запись файла
3. Перезапустите бот при критических ошибках

### Проверка состояния
```bash
# Проверка sync сервера
curl http://localhost:8765/health

# Ручная перезагрузка
curl -X POST http://localhost:8765/reload-config

# Проверка портов
lsof -i :8765
lsof -i :5001
```

## Резервный режим

Если автосинхронизация не работает:

1. **Изменения через файл**
   - Отредактируйте `config.py` вручную
   - ConfigManager обнаружит изменения автоматически

2. **Ручной перезапуск**
   - Остановите бота (Ctrl+C)
   - Перезапустите: `python bot.py`

## Преимущества новой системы

✅ **Без перезапусков** - изменения применяются мгновенно
✅ **Удобство** - всё через веб-интерфейс
✅ **Безопасность** - валидация и откат при ошибках
✅ **Мониторинг** - статус синхронизации в реальном времени
✅ **Надежность** - резервные механизмы при сбоях

## Запуск с автосинхронизацией

```bash
# Терминал 1 - Бот с hot reload
python bot.py

# Терминал 2 - Админ-панель
python admin_server.py

# Админ-панель: http://localhost:5001
# Sync API: http://localhost:8765
```

**Система готова!** Теперь все изменения в админ-панели применяются к боту автоматически! 🚀